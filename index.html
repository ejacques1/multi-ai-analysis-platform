<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-AI Qualitative Analysis Platform</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 10px;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .auth-section {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            text-align: center;
        }

        .auth-section.hidden {
            display: none;
        }

        .landing-section {
            background: white;
            padding: 3rem 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .landing-section.hidden {
            display: none;
        }

        .hero-content {
            max-width: 1000px;
            margin: 0 auto;
            text-align: center;
        }

        .hero-content h2 {
            font-size: 2.2rem;
            color: #333;
            margin-bottom: 1rem;
        }

        .hero-description {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 3rem;
            line-height: 1.6;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .feature-card {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 10px;
            text-align: left;
        }

        .feature-card h3 {
            color: #495057;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .feature-card p {
            color: #6c757d;
            line-height: 1.5;
        }

        .demo-preview {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 3rem;
        }

        .demo-preview h3 {
            color: #495057;
            margin-bottom: 1.5rem;
        }

        .sample-table {
            overflow-x: auto;
            margin-bottom: 1rem;
        }

        .sample-table table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .sample-table th,
        .sample-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .sample-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .sample-table .totals-row {
            background: #f8f9fa;
            font-weight: bold;
        }

        .sample-note {
            color: #6c757d;
            font-style: italic;
            text-align: center;
        }

        .pricing-overview {
            display: flex;
            gap: 2rem;
            justify-content: center;
            margin-bottom: 3rem;
        }

        .pricing-card {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
            min-width: 200px;
            border: 2px solid transparent;
        }

        .pricing-card.premium {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .pricing-card h4 {
            color: #495057;
            margin-bottom: 1rem;
        }

        .pricing-card p {
            color: #6c757d;
            line-height: 1.6;
        }

        .btn-large {
            font-size: 1.2rem;
            padding: 16px 32px;
            margin-bottom: 1rem;
        }

        .tab-nav {
            display: flex;
            background: white;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tab-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            background: #667eea;
            color: white;
        }

        .tab-btn:hover:not(.active) {
            background: #f0f0f0;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #555;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .code-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .code-item h4 {
            color: #495057;
            margin-bottom: 0.5rem;
        }

        .code-item p {
            color: #6c757d;
            margin-bottom: 0.5rem;
        }

        .code-actions {
            display: flex;
            gap: 10px;
        }

        .file-upload {
            border: 2px dashed #667eea;
            border-radius: 6px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload:hover {
            border-color: #5a6fd8;
            background: #f8f9ff;
        }

        .file-upload.dragover {
            border-color: #5a6fd8;
            background: #f0f4ff;
        }

        .tier-section {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }

        .tier-section.active {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .tier-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .tier-header h3 {
            margin: 0;
            color: #495057;
        }

        .tier-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .tier-badge.free {
            background: #d4edda;
            color: #155724;
        }

        .tier-badge.premium {
            background: #667eea;
            color: white;
        }

        .tier-features {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            align-items: start;
        }

        .feature-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .feature {
            color: #495057;
            font-size: 0.95rem;
        }

        .usage-meter {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
        }

        .usage-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: #495057;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .premium-config {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
        }

        .info-text {
            color: #667eea;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .api-config small {
            display: block;
            color: #6c757d;
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .tier-section.premium-tier .tier-features {
            grid-template-columns: 1fr;
        }

        .results-container {
            overflow-x: auto;
            margin-top: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
            background: white;
        }

        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
            white-space: nowrap;
        }

        .results-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .results-table .code-header {
            text-align: center;
            min-width: 120px;
        }

        .results-table .placeholder-code {
            color: #6c757d;
            font-style: italic;
        }

        .results-table .real-code {
            color: #495057;
            font-weight: 600;
        }

        .results-table .code-cell {
            text-align: center;
            font-weight: 600;
        }

        .results-table .totals-row {
            background: #f8f9fa;
            font-weight: bold;
        }

        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .alert-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .hidden {
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: #667eea;
            width: 0%;
            transition: width 0.3s ease;
        }

        .user-info {
            background: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info.hidden {
            display: none;
        }

        .processing-indicator {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .processing-indicator.hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .tier-features {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .tier-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .action-buttons {
                flex-direction: column;
            }

            .tab-nav {
                flex-wrap: wrap;
            }

            .tab-btn {
                min-width: auto;
                flex: 1 1 auto;
            }

            .user-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Multi-AI Qualitative Analysis</h1>
            <p class="subtitle">Advanced content analysis with multiple AI models for research reliability</p>
        </header>

        <div id="alert-container"></div>

        <div id="landing-section" class="landing-section">
            <div class="hero-content">
                <h2>Automated Qualitative Content Analysis for Researchers</h2>
                <p class="hero-description">
                    Analyze PDF articles against custom coding schemes using multiple AI models. 
                    Get binary coding results (1/0) with evidence tracking and inter-rater reliability checking.
                </p>
                
                <div class="features-grid">
                    <div class="feature-card">
                        <h3>🎯 Custom Coding Schemes</h3>
                        <p>Define your own codes with operational definitions. AI analyzes content based on your research framework, not keywords.</p>
                    </div>
                    
                    <div class="feature-card">
                        <h3>📊 Multi-Model Reliability</h3>
                        <p>Compare results across GPT-4, Claude 3.5, and Gemini for validation. See where models agree and disagree.</p>
                    </div>
                    
                    <div class="feature-card">
                        <h3>📄 PDF Analysis</h3>
                        <p>Upload academic papers, reports, or articles. Extract text automatically with page number tracking for evidence citations.</p>
                    </div>
                    
                    <div class="feature-card">
                        <h3>💾 Export & Evidence</h3>
                        <p>Get CSV results with complete evidence tracking. Every coding decision backed by specific quotes and page numbers.</p>
                    </div>
                </div>

                <div class="demo-preview">
                    <h3>Example Output</h3>
                    <div class="sample-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Article</th>
                                    <th>Emotional Support</th>
                                    <th>Technical Detail</th>
                                    <th>Innovation</th>
                                    <th>Methodology</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Research_Paper_1.pdf</td>
                                    <td>1</td>
                                    <td>0</td>
                                    <td>1</td>
                                    <td>1</td>
                                </tr>
                                <tr>
                                    <td>Study_Report_2.pdf</td>
                                    <td>0</td>
                                    <td>1</td>
                                    <td>0</td>
                                    <td>1</td>
                                </tr>
                                <tr class="totals-row">
                                    <td><strong>TOTAL</strong></td>
                                    <td><strong>1</strong></td>
                                    <td><strong>1</strong></td>
                                    <td><strong>1</strong></td>
                                    <td><strong>2</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <p class="sample-note">Binary coding (1=present, 0=absent) with frequency totals and evidence tracking</p>
                </div>

                <div class="pricing-overview">
                    <div class="pricing-card">
                        <h4>Free Tier</h4>
                        <p>10 analyses/month<br>Up to 5 articles<br>GPT-3.5 analysis</p>
                    </div>
                    <div class="pricing-card premium">
                        <h4>Premium</h4>
                        <p>Unlimited analyses<br>Your API keys<br>Multi-model reliability</p>
                    </div>
                </div>

                <button class="btn btn-large" onclick="showAuthSection()">Get Started - Sign Up Free</button>
                <p style="margin-top: 1rem; color: #6c757d;">
                    Already have an account? <a href="#" onclick="showAuthSection(true)">Sign in here</a>
                </p>
            </div>
        </div>

        <div id="auth-section" class="auth-section hidden">
            <h2>Sign In to Get Started</h2>
            <p style="margin-bottom: 2rem;">Create an account or sign in to access your analysis projects and usage tracking.</p>
            
            <div id="auth-forms">
                <div id="signin-form">
                    <h3>Sign In</h3>
                    <div class="form-group">
                        <input type="email" id="signin-email" placeholder="Email" />
                    </div>
                    <div class="form-group">
                        <input type="password" id="signin-password" placeholder="Password" />
                    </div>
                    <button class="btn" onclick="signIn()" id="signin-btn">Sign In</button>
                    <p style="margin-top: 1rem;">
                        Don't have an account? 
                        <a href="#" onclick="showSignUpForm()">Sign up here</a>
                    </p>
                </div>

                <div id="signup-form" class="hidden">
                    <h3>Create Account</h3>
                    <div class="form-group">
                        <input type="text" id="signup-name" placeholder="Full Name" />
                    </div>
                    <div class="form-group">
                        <input type="email" id="signup-email" placeholder="Email" />
                    </div>
                    <div class="form-group">
                        <input type="password" id="signup-password" placeholder="Password" />
                    </div>
                    <button class="btn" onclick="signUp()" id="signup-btn">Create Account</button>
                    <p style="margin-top: 1rem;">
                        Already have an account? 
                        <a href="#" onclick="showSignInForm()">Sign in here</a>
                    </p>
                </div>
            </div>
        </div>

        <div id="user-info" class="user-info hidden">
            <div>
                <strong id="user-name">Welcome!</strong>
                <span id="user-tier-info"> - Free Tier</span>
            </div>
            <button class="btn btn-secondary" onclick="signOut()" id="signout-btn">Sign Out</button>
        </div>

        <nav class="tab-nav hidden" id="main-nav">
            <button class="tab-btn active" onclick="showTab('results')">Expected Output</button>
            <button class="tab-btn" onclick="showTab('setup')">Setup & Config</button>
            <button class="tab-btn" onclick="showTab('codes')">Coding Schemes</button>
            <button class="tab-btn" onclick="showTab('upload')">Upload Articles</button>
            <button class="tab-btn" onclick="showTab('analysis')">Run Analysis</button>
        </nav>

        <div id="results" class="tab-content active hidden">
            <h2>Analysis Results</h2>
            <p>This shows your analysis results. The table dynamically adapts to your coding scheme.</p>

            <div style="margin-bottom: 2rem;">
                <button class="btn" onclick="exportResults()" id="export-btn" disabled>Export to CSV</button>
                <button class="btn btn-secondary" onclick="generateAllSummaries()" id="summaries-btn" disabled>Generate AI Summaries</button>
                <span style="margin-left: 1rem; color: #6c757d; font-size: 0.9rem;" id="export-status">Analysis complete - ready to export</span>
            </div>

            <div class="results-container">
                <table class="results-table" id="results-table">
                    <thead id="results-header"></thead>
                    <tbody id="results-body"></tbody>
                </table>
            </div>

            <div id="summary-section" class="hidden">
                <h3>AI-Generated Summaries</h3>
                <div id="summary-content"></div>
            </div>
        </div>

        <div id="setup" class="tab-content hidden">
            <h2>API Configuration</h2>
            <p>Choose between our free tier or bring your own API keys for unlimited usage.</p>
            
            <div class="tier-section free-tier active">
                <div class="tier-header">
                    <h3>🎯 FREE TIER (Powered by our API keys)</h3>
                    <span class="tier-badge free">Currently Active</span>
                </div>
                <div class="tier-features">
                    <div class="feature-list">
                        <div class="feature">✅ 10 analyses per month</div>
                        <div class="feature">✅ Up to 5 articles per analysis</div>
                        <div class="feature">✅ GPT-3.5 Turbo analysis</div>
                        <div class="feature">✅ Basic reliability checking</div>
                    </div>
                    <div class="usage-meter">
                        <div class="usage-header">
                            <span>Usage this month:</span>
                            <span id="usage-count">Loading...</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="usage-progress"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tier-section premium-tier">
                <div class="tier-header">
                    <h3>🚀 PREMIUM TIER (Your own API keys = unlimited)</h3>
                    <label class="toggle-switch">
                        <input type="checkbox" id="premium-toggle" onchange="togglePremiumMode()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="tier-features">
                    <div class="feature-list">
                        <div class="feature">• Unlimited analyses</div>
                        <div class="feature">• Latest AI models (GPT-4, Claude 3.5, etc.)</div>
                        <div class="feature">• Multi-model reliability checking</div>
                        <div class="feature">• Priority processing</div>
                    </div>
                </div>

                <div id="premium-config" class="premium-config hidden">
                    <p class="info-text">ℹ️ Enter at least one API key to enable premium features</p>
                    <div class="api-config">
                        <div class="form-group">
                            <label for="openai-key">OpenAI API Key (Optional)</label>
                            <input type="password" id="openai-key" placeholder="sk-..." />
                            <small>For GPT-4, GPT-3.5 models</small>
                        </div>
                        <div class="form-group">
                            <label for="anthropic-key">Anthropic API Key (Optional)</label>
                            <input type="password" id="anthropic-key" placeholder="sk-ant-..." />
                            <small>For Claude 3.5 Sonnet models</small>
                        </div>
                        <div class="form-group">
                            <label for="google-key">Google AI API Key (Optional)</label>
                            <input type="password" id="google-key" placeholder="AI..." />
                            <small>For Gemini models</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn" onclick="saveConfiguration()">Save Configuration</button>
                <button class="btn btn-secondary" onclick="testConnection()" id="test-btn">Test Connection</button>
            </div>
        </div>

        <div id="codes" class="tab-content hidden">
            <h2>Coding Schemes</h2>
            <p>Define your codes and operational definitions for analysis. Your schemes are saved to your account.</p>

            <div class="form-group">
                <label for="scheme-name">Coding Scheme Name</label>
                <input type="text" id="scheme-name" placeholder="e.g., Emotional Support Analysis" />
            </div>

            <h3>Add New Code</h3>
            <div class="form-group">
                <label for="code-name">Code Name</label>
                <input type="text" id="code-name" placeholder="e.g., Emotional Support" />
            </div>
            <div class="form-group">
                <label for="code-definition">Operational Definition</label>
                <textarea id="code-definition" placeholder="Detailed description of what this code represents and how to identify it in text..."></textarea>
            </div>
            <button class="btn" onclick="addCode()">Add Code</button>

            <h3>Current Codes</h3>
            <div id="codes-list">
            </div>

            <button class="btn" onclick="saveCodingScheme()">Save Coding Scheme</button>
            <button class="btn btn-secondary" onclick="loadCodingSchemes()">Load Saved Schemes</button>
            <div id="save-status" style="margin-top: 1rem; font-size: 0.9rem; color: #28a745;">
            </div>
        </div>

        <div id="upload" class="tab-content hidden">
            <h2>Upload Articles</h2>
            <p>Upload PDF articles for analysis. Files are saved to your account for reuse across analyses.</p>

            <div id="processing-indicator" class="processing-indicator hidden">
                <strong>Processing files...</strong>
                <div id="processing-details"></div>
            </div>

            <div class="file-upload" onclick="document.getElementById('file-input').click()" 
                 ondrop="handleFileDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                <p>Click to select PDF files or drag and drop them here</p>
                <p style="color: #6c757d; font-size: 0.9rem;">Supports multiple PDF files (max 50MB each)</p>
            </div>
            <input type="file" id="file-input" multiple accept=".pdf" style="display: none;" onchange="handleFileSelect(event)" />

            <div id="file-list" style="margin-top: 2rem;">
            </div>
        </div>

        <div id="analysis" class="tab-content hidden">
            <h2>Run Analysis</h2>
            <p>Execute real AI analysis across your uploaded articles using your configured models.</p>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="enable-reliability" checked />
                    Enable Multi-Model Reliability Check (Premium only)
                </label>
                <p style="color: #6c757d; font-size: 0.9rem;">Compare results across different AI models for validation</p>
            </div>

            <button class="btn" onclick="startAnalysis()" id="start-analysis-btn">
                Start AI Analysis
            </button>

            <div id="analysis-progress" class="hidden">
                <h3>Analysis Progress</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <p id="progress-text">Initializing...</p>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://snuripsvqwuvgqrmnnab.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNudXJpcHN2cXd1dmdxcm1ubmFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzOTEyODUsImV4cCI6MjA3Mzk2NzI4NX0.H1PbpdmxhWvdlMR2X46ioFGp4pWWTeytMSK0b7c2xmo'

        let supabase = null
        let currentUser = null
        let currentCodes = []
        let uploadedFiles = []
        let analysisResults = []
        let isPremiumMode = false
        let currentSchemeId = null

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js'

        document.addEventListener('DOMContentLoaded', function() {
            console.log('App initializing...')
            if (initializeSupabase()) {
                handleAuthStateChange()
                renderResultsTable()
                renderCodes()
                renderFileList()
            }
        })

        function initializeSupabase() {
            try {
                if (typeof window.supabase === 'undefined') {
                    console.error('Supabase library not loaded')
                    showAlert('Failed to load required libraries. Please refresh the page.', 'error')
                    return false
                }
                
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
                console.log('Supabase initialized successfully')
                return true
            } catch (error) {
                console.error('Failed to initialize Supabase:', error)
                showAlert('Failed to connect to backend service', 'error')
                return false
            }
        }

        function showAuthSection(isSignIn = false) {
            document.getElementById('landing-section').classList.add('hidden')
            document.getElementById('auth-section').classList.remove('hidden')
            document.getElementById('user-info').classList.add('hidden')
            document.getElementById('main-nav').classList.add('hidden')
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden')
            })
            
            if (isSignIn) {
                showSignInForm()
            } else {
                showSignUpForm()
            }
        }

        function showLandingSection() {
            document.getElementById('landing-section').classList.remove('hidden')
            document.getElementById('auth-section').classList.add('hidden')
            document.getElementById('user-info').classList.add('hidden')
            document.getElementById('main-nav').classList.add('hidden')
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden')
            })
        }

        function showMainApp() {
            document.getElementById('landing-section').classList.add('hidden')
            document.getElementById('auth-section').classList.add('hidden')
            document.getElementById('user-info').classList.remove('hidden')
            document.getElementById('main-nav').classList.remove('hidden')
            document.getElementById('results').classList.remove('hidden')
            document.getElementById('results').classList.add('active')
            
            loadUserData()
        }

        function showSignUpForm() {
            document.getElementById('signin-form').classList.add('hidden')
            document.getElementById('signup-form').classList.remove('hidden')
        }

        function showSignInForm() {
            document.getElementById('signup-form').classList.add('hidden')
            document.getElementById('signin-form').classList.remove('hidden')
        }

        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alert-container')
            const alertDiv = document.createElement('div')
            alertDiv.className = `alert alert-${type} show`
            alertDiv.textContent = message
            
            alertContainer.innerHTML = ''
            alertContainer.appendChild(alertDiv)
            
            if (type === 'success') {
                setTimeout(() => {
                    alertDiv.classList.remove('show')
                    setTimeout(() => alertDiv.remove(), 300)
                }, 5000)
            }
            
            console.log(`Alert (${type}):`, message)
        }

        async function signUp() {
            const nameInput = document.getElementById('signup-name')
            const emailInput = document.getElementById('signup-email')
            const passwordInput = document.getElementById('signup-password')
            const signupBtn = document.getElementById('signup-btn')

            const name = nameInput.value.trim()
            const email = emailInput.value.trim()
            const password = passwordInput.value

            if (!name || !email || !password) {
                showAlert('Please fill in all fields', 'error')
                return
            }

            if (password.length < 6) {
                showAlert('Password must be at least 6 characters', 'error')
                return
            }

            signupBtn.disabled = true
            signupBtn.textContent = 'Creating Account...'

            try {
                console.log('Attempting to sign up with email:', email)
                
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            full_name: name
                        }
                    }
                })

                if (error) {
                    console.error('Sign up error:', error)
                    throw error
                }

                console.log('Sign up successful:', data)

                if (data.user && !data.user.email_confirmed_at) {
                    showAlert('Account created! Please check your email to verify your account before signing in.', 'success')
                    nameInput.value = ''
                    emailInput.value = ''
                    passwordInput.value = ''
                    showSignInForm()
                } else {
                    showAlert('Account created successfully!', 'success')
                }
            } catch (error) {
                console.error('Sign up error:', error)
                showAlert(`Sign up failed: ${error.message}`, 'error')
            } finally {
                signupBtn.disabled = false
                signupBtn.textContent = 'Create Account'
            }
        }

        async function signIn() {
            const emailInput = document.getElementById('signin-email')
            const passwordInput = document.getElementById('signin-password')
            const signinBtn = document.getElementById('signin-btn')

            const email = emailInput.value.trim()
            const password = passwordInput.value

            if (!email || !password) {
                showAlert('Please enter email and password', 'error')
                return
            }

            signinBtn.disabled = true
            signinBtn.textContent = 'Signing In...'

            try {
                console.log('Attempting to sign in with email:', email)
                
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                })

                if (error) {
                    console.error('Sign in error:', error)
                    throw error
                }

                console.log('Sign in successful:', data)
                showAlert('Signed in successfully!', 'success')
                
                emailInput.value = ''
                passwordInput.value = ''
                
            } catch (error) {
                console.error('Sign in error:', error)
                if (error.message.includes('Invalid login credentials')) {
                    showAlert('Invalid email or password. Please check your credentials.', 'error')
                } else if (error.message.includes('Email not confirmed')) {
                    showAlert('Please check your email and click the verification link before signing in.', 'error')
                } else {
                    showAlert(`Sign in failed: ${error.message}`, 'error')
                }
            } finally {
                signinBtn.disabled = false
                signinBtn.textContent = 'Sign In'
            }
        }

        async function signOut() {
            const signoutBtn = document.getElementById('signout-btn')
            
            signoutBtn.disabled = true
            signoutBtn.textContent = 'Signing Out...'
            
            try {
                console.log('Attempting to sign out')
                
                const { error } = await supabase.auth.signOut()
                if (error) {
                    console.error('Sign out error:', error)
                    throw error
                }
                
                console.log('Sign out successful')
                showAlert('Signed out successfully!', 'success')
                
            } catch (error) {
                console.error('Sign out error:', error)
                showAlert(`Sign out failed: ${error.message}`, 'error')
            } finally {
                signoutBtn.disabled = false
                signoutBtn.textContent = 'Sign Out'
            }
        }

        function handleAuthStateChange() {
            supabase.auth.onAuthStateChange(async (event, session) => {
                console.log('Auth state changed:', event, session?.user?.email)
                
                if (session && session.user) {
                    currentUser = session.user
                    await loadUserProfile()
                    showMainApp()
                } else {
                    currentUser = null
                    showLandingSection()
                }
            })
        }

        async function loadUserProfile() {
            try {
                console.log('Loading user profile for:', currentUser.id)
                
                const userEmail = currentUser.email
                const userName = currentUser.user_metadata?.full_name || userEmail
                
                document.getElementById('user-name').textContent = `Welcome, ${userName}!`
                document.getElementById('user-tier-info').textContent = ' - Free Tier'
                
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single()

                if (error && error.code !== 'PGRST116') {
                    console.warn('Could not load user profile from database:', error)
                    return
                }

                if (data) {
                    if (data.full_name) {
                        document.getElementById('user-name').textContent = `Welcome, ${data.full_name}!`
                    }
                    
                    let tierText = ''
                    if (data.is_admin) {
                        tierText = ' - Admin (Unlimited)'
                    } else if (data.is_premium) {
                        tierText = ' - Premium Tier'
                    } else {
                        tierText = ' - Free Tier'
                    }
                    document.getElementById('user-tier-info').textContent = tierText
                    
                    if (data.is_admin) {
                        updateUsageDisplay('unlimited')
                    } else {
                        updateUsageDisplay(data.usage_count || 0)
                    }

                    if (data.is_premium && data.api_keys) {
                        loadApiKeys(data.api_keys)
                    }
                }
                
            } catch (error) {
                console.error('Error loading user profile:', error)
            }
        }

        async function loadUserData() {
            console.log('Loading user data...')
            try {
                await loadCodingSchemes()
                await loadUploadedArticles()
                renderResultsTable()
                console.log('User data loaded successfully')
            } catch (error) {
                console.error('Error loading user data:', error)
                showAlert('Some data could not be loaded. Please refresh the page.', 'warning')
            }
        }

        function loadApiKeys(apiKeys) {
            if (apiKeys.openai) document.getElementById('openai-key').value = apiKeys.openai
            if (apiKeys.anthropic) document.getElementById('anthropic-key').value = apiKeys.anthropic
            if (apiKeys.google) document.getElementById('google-key').value = apiKeys.google
            
            if (Object.keys(apiKeys).length > 0) {
                document.getElementById('premium-toggle').checked = true
                togglePremiumMode()
            }
        }

        function updateUsageDisplay(usageCount) {
            const usageElement = document.getElementById('usage-count')
            const progressElement = document.getElementById('usage-progress')
            
            if (usageElement && progressElement) {
                if (usageCount === 'unlimited') {
                    usageElement.textContent = 'Unlimited (Admin)'
                    progressElement.style.width = '100%'
                    progressElement.style.background = '#28a745'
                } else {
                    usageElement.textContent = `${usageCount}/10 analyses used`
                    const percentage = (usageCount / 10) * 100
                    progressElement.style.width = `${Math.min(percentage, 100)}%`
                    
                    if (percentage >= 80) {
                        progressElement.style.background = '#dc3545'
                    } else if (percentage >= 60) {
                        progressElement.style.background = '#ffc107'
                    } else {
                        progressElement.style.background = '#667eea'
                    }
                }
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div')
            div.textContent = text
            return div.innerHTML
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active')
                tab.classList.add('hidden')
            })
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active')
            })

            document.getElementById(tabId).classList.add('active')
            document.getElementById(tabId).classList.remove('hidden')
            event.target.classList.add('active')
        }

        function togglePremiumMode() {
            isPremiumMode = document.getElementById('premium-toggle').checked
            const premiumConfig = document.getElementById('premium-config')
            const freeTier = document.querySelector('.free-tier')
            const premiumTier = document.querySelector('.premium-tier')
            
            if (isPremiumMode) {
                premiumConfig.classList.remove('hidden')
                freeTier.classList.remove('active')
                premiumTier.classList.add('active')
                freeTier.querySelector('.tier-badge').textContent = 'Available'
                freeTier.querySelector('.tier-badge').className = 'tier-badge'
                
                let premiumBadge = premiumTier.querySelector('.tier-badge')
                if (!premiumBadge) {
                    premiumBadge = document.createElement('span')
                    premiumTier.querySelector('.tier-header').appendChild(premiumBadge)
                }
                premiumBadge.textContent = 'Currently Active'
                premiumBadge.className = 'tier-badge premium'
            } else {
                premiumConfig.classList.add('hidden')
                freeTier.classList.add('active')
                premiumTier.classList.remove('active')
                freeTier.querySelector('.tier-badge').textContent = 'Currently Active'
                freeTier.querySelector('.tier-badge').className = 'tier-badge free'
                
                const premiumBadge = premiumTier.querySelector('.tier-badge')
                if (premiumBadge) {
                    premiumBadge.textContent = 'Available'
                    premiumBadge.className = 'tier-badge'
                }
            }
        }

        async function saveConfiguration() {
            if (!currentUser) {
                showAlert('Please sign in to save configuration', 'error')
                return
            }

            const apiKeys = {}
            if (isPremiumMode) {
                const openaiKey = document.getElementById('openai-key').value.trim()
                const anthropicKey = document.getElementById('anthropic-key').value.trim()
                const googleKey = document.getElementById('google-key').value.trim()
                
                if (openaiKey) apiKeys.openai = openaiKey
                if (anthropicKey) apiKeys.anthropic = anthropicKey
                if (googleKey) apiKeys.google = googleKey
            }

            try {
                const { error } = await supabase
                    .from('users')
                    .update({
                        is_premium: isPremiumMode,
                        api_keys: apiKeys,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', currentUser.id)

                if (error) throw error

                showAlert('Configuration saved successfully!', 'success')
            } catch (error) {
                showAlert(`Failed to save configuration: ${error.message}`, 'error')
            }
        }

        async function testConnection() {
            const testBtn = document.getElementById('test-btn')
            testBtn.disabled = true
            testBtn.textContent = 'Testing...'
            
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('id')
                    .eq('id', currentUser.id)
                    .single()

                if (error) throw error

                if (isPremiumMode) {
                    const hasKeys = document.getElementById('openai-key').value || 
                                   document.getElementById('anthropic-key').value || 
                                   document.getElementById('google-key').value
                    
                    if (hasKeys) {
                        showAlert('Connection successful! Premium mode ready.', 'success')
                    } else {
                        showAlert('Please enter at least one API key for premium mode.', 'warning')
                    }
                } else {
                    showAlert('Connection successful! Free tier ready.', 'success')
                }
            } catch (error) {
                showAlert(`Connection test failed: ${error.message}`, 'error')
            } finally {
                testBtn.disabled = false
                testBtn.textContent = 'Test Connection'
            }
        }

        async function addCode() {
            const name = document.getElementById('code-name').value.trim()
            const definition = document.getElementById('code-definition').value.trim()

            if (!name || !definition) {
                showAlert('Please enter both code name and definition', 'error')
                return
            }

            if (currentCodes.some(code => code.name.toLowerCase() === name.toLowerCase())) {
                showAlert('A code with this name already exists', 'error')
                return
            }

            const code = {
                id: Date.now(),
                name: name,
                definition: definition
            }

            currentCodes.push(code)
            console.log('Code added:', code)
            console.log('Current codes:', currentCodes)
            
            renderCodes()
            renderResultsTable()

            document.getElementById('code-name').value = ''
            document.getElementById('code-definition').value = ''
            
            updateSaveStatus(false)
            
            showAlert(`Code "${name}" added successfully!`, 'success')
        }

        function removeCode(id) {
            const codeIndex = currentCodes.findIndex(code => code.id === id)
            if (codeIndex > -1) {
                const codeName = currentCodes[codeIndex].name
                currentCodes.splice(codeIndex, 1)
                console.log('Code removed:', codeName)
                console.log('Current codes:', currentCodes)
                
                renderCodes()
                renderResultsTable()
                
                updateSaveStatus(false)
                
                showAlert(`Code "${codeName}" removed successfully!`, 'success')
            }
        }

        function renderCodes() {
            const codesList = document.getElementById('codes-list')
            console.log('Rendering codes:', currentCodes)
            
            if (currentCodes.length === 0) {
                codesList.innerHTML = '<p style="color: #6c757d;">No codes defined yet. Add your first code above.</p>'
                return
            }

            let codesHTML = ''
            currentCodes.forEach(code => {
                codesHTML += `
                    <div class="code-item">
                        <h4>${escapeHtml(code.name)}</h4>
                        <p>${escapeHtml(code.definition)}</p>
                        <div class="code-actions">
                            <button class="btn btn-danger" onclick="removeCode(${code.id})">Remove</button>
                        </div>
                    </div>
                `
            })
            
            codesList.innerHTML = codesHTML
            console.log('Codes rendered to DOM')
        }

        async function saveCodingScheme() {
            const schemeName = document.getElementById('scheme-name').value.trim()
            if (!schemeName || currentCodes.length === 0) {
                showAlert('Please enter a scheme name and add at least one code', 'error')
                return
            }

            if (!currentUser) {
                showAlert('Please sign in to save coding scheme', 'error')
                return
            }

            try {
                const codesData = currentCodes.map(code => ({
                    name: code.name,
                    definition: code.definition
                }))

                let result
                if (currentSchemeId) {
                    result = await supabase
                        .from('coding_schemes')
                        .update({
                            name: schemeName,
                            codes: codesData,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', currentSchemeId)
                        .eq('user_id', currentUser.id)
                        .select()
                        .single()
                } else {
                    result = await supabase
                        .from('coding_schemes')
                        .insert({
                            user_id: currentUser.id,
                            name: schemeName,
                            codes: codesData
                        })
                        .select()
                        .single()
                }

                if (result.error) throw result.error

                currentSchemeId = result.data.id
                showAlert(`Coding scheme "${schemeName}" saved successfully!`, 'success')
                
                updateSaveStatus(true)
                
            } catch (error) {
                console.error('Error saving coding scheme:', error)
                showAlert(`Failed to save coding scheme: ${error.message}`, 'error')
            }
        }

        async function loadCodingSchemes() {
            if (!currentUser) {
                console.log('No user logged in, skipping coding scheme load')
                return
            }
            
            try {
                console.log('Loading coding schemes for user:', currentUser.id)
                
                const { data, error } = await supabase
                    .from('coding_schemes')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })

                if (error) {
                    console.error('Error loading coding schemes:', error)
                    throw error
                }

                if (data && data.length > 0) {
                    const latestScheme = data[0]
                    currentSchemeId = latestScheme.id
                    document.getElementById('scheme-name').value = latestScheme.name
                    
                    currentCodes = latestScheme.codes.map((code, index) => ({
                        id: Date.now() + index,
                        name: code.name,
                        definition: code.definition
                    }))
                    
                    renderCodes()
                    console.log('Loaded coding scheme:', latestScheme.name, 'with', currentCodes.length, 'codes')
                    
                    showAlert(`Loaded coding scheme: "${latestScheme.name}" with ${currentCodes.length} codes`, 'success')
                } else {
                    console.log('No saved coding schemes found')
                    currentCodes = []
                    currentSchemeId = null
                    document.getElementById('scheme-name').value = ''
                    renderCodes()
                }
                
                renderResultsTable()
                
            } catch (error) {
                console.error('Error loading coding schemes:', error)
                showAlert('Could not load saved coding schemes. You can create new ones.', 'warning')
                
                currentCodes = []
                currentSchemeId = null
                document.getElementById('scheme-name').value = ''
                renderCodes()
                renderResultsTable()
            }
        }

        async function loadUploadedArticles() {
            if (!currentUser) {
                console.log('No user logged in, skipping file load')
                return
            }
            
            try {
                const { data, error } = await supabase
                    .from('articles')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('uploaded_at', { ascending: false })

                if (error) throw error

                if (data && data.length > 0) {
                    uploadedFiles = data.map(article => ({
                        id: article.id,
                        name: article.filename,
                        size: article.file_size,
                        text: article.extracted_text,
                        pageTexts: article.page_texts,
                        uploaded: article.uploaded_at
                    }))
                    
                    renderFileList()
                    renderResultsTable()
                    
                    console.log('Loaded articles:', uploadedFiles.length)
                }
            } catch (error) {
                console.error('Error loading articles:', error)
            }
        }

        function handleFileDrop(e) {
            e.preventDefault()
            e.target.classList.remove('dragover')
            const files = Array.from(e.dataTransfer.files).filter(file => file.type === 'application/pdf')
            if (files.length === 0) {
                showAlert('Please select PDF files only', 'warning')
                return
            }
            processFiles(files)
        }

        function handleDragOver(e) {
            e.preventDefault()
            e.target.classList.add('dragover')
        }

        function handleDragLeave(e) {
            e.target.classList.remove('dragover')
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files)
            if (files.length === 0) return
            
            const pdfFiles = files.filter(file => file.type === 'application/pdf')
            if (pdfFiles.length === 0) {
                showAlert('Please select PDF files only', 'warning')
                return
            }
            
            if (pdfFiles.length !== files.length) {
                showAlert(`Only ${pdfFiles.length} of ${files.length} files are PDFs. Processing PDFs only.`, 'warning')
            }
            
            processFiles(pdfFiles)
        }

        async function processFiles(files) {
            console.log('Processing files:', files.length)
            
            const processingIndicator = document.getElementById('processing-indicator')
            const processingDetails = document.getElementById('processing-details')
            
            processingIndicator.classList.remove('hidden')
            processingDetails.innerHTML = `Processing ${files.length} file(s)...`
            
            let successCount = 0
            let errorCount = 0
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i]
                
                try {
                    console.log(`Processing file ${i + 1}/${files.length}: ${file.name}`)
                    processingDetails.innerHTML = `Processing ${file.name} (${i + 1}/${files.length})...`
                    
                    if (file.size > 50 * 1024 * 1024) {
                        throw new Error(`File "${file.name}" is too large (max 50MB)`)
                    }

                    const text = await extractTextFromPDF(file)
                    
                    const fileData = {
                        id: Date.now() + Math.random(),
                        name: file.name,
                        size: file.size,
                        text: text.fullText,
                        pageTexts: text.pageTexts,
                        uploaded: new Date().toISOString()
                    }

                    if (currentUser) {
                        await saveFileToDatabase(fileData)
                    }

                    uploadedFiles.push(fileData)
                    successCount++
                    
                } catch (error) {
                    console.error(`Error processing file ${file.name}:`, error)
                    errorCount++
                    processingDetails.innerHTML = `Error processing ${file.name}: ${error.message}`
                    await new Promise(resolve => setTimeout(resolve, 2000))
                }
            }
            
            processingIndicator.classList.add('hidden')
            
            if (successCount > 0) {
                renderFileList()
                renderResultsTable()
                showAlert(`Successfully processed ${successCount} file(s)${errorCount > 0 ? `, ${errorCount} failed` : ''}`, 'success')
            } else {
                showAlert(`Failed to process any files (${errorCount} errors)`, 'error')
            }
        }

        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer()
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise
            
            const pageTexts = []
            let fullText = ''
            
            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                const page = await pdf.getPage(pageNum)
                const textContent = await page.getTextContent()
                
                const pageText = textContent.items.map(item => item.str).join(' ')
                pageTexts.push({
                    page: pageNum,
                    text: pageText
                })
                
                fullText += `[Page ${pageNum}] ${pageText}\n\n`
            }
            
            return {
                fullText: fullText.trim(),
                pageTexts: pageTexts
            }
        }

        async function saveFileToDatabase(fileData) {
            try {
                const { error } = await supabase
                    .from('articles')
                    .insert({
                        user_id: currentUser.id,
                        filename: fileData.name,
                        file_size: fileData.size,
                        extracted_text: fileData.text,
                        page_texts: fileData.pageTexts,
                        uploaded_at: fileData.uploaded
                    })

                if (error) throw error
                
                console.log('File saved to database:', fileData.name)
            } catch (error) {
                console.error('Error saving file to database:', error)
            }
        }

        function renderFileList() {
            const fileList = document.getElementById('file-list')
            
            if (uploadedFiles.length === 0) {
                fileList.innerHTML = '<p style="color: #6c757d;">No files uploaded yet. Upload PDF files above to get started.</p>'
                return
            }

            let filesHTML = '<h3>Uploaded Files</h3>'
            uploadedFiles.forEach((file, index) => {
                const uploadDate = new Date(file.uploaded).toLocaleDateString()
                const fileSize = formatFileSize(file.size)
                
                filesHTML += `
                    <div class="code-item">
                        <h4>${escapeHtml(file.name)}</h4>
                        <p>Size: ${fileSize} | Uploaded: ${uploadDate}</p>
                        <div class="code-actions">
                            <button class="btn btn-danger" onclick="removeFile(${index})">Remove</button>
                        </div>
                    </div>
                `
            })
            
            fileList.innerHTML = filesHTML
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B'
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB'
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB'
        }

        function removeFile(index) {
            const fileName = uploadedFiles[index].name
            uploadedFiles.splice(index, 1)
            renderFileList()
            renderResultsTable()
            showAlert(`File "${fileName}" removed successfully!`, 'success')
        }

        function renderResultsTable() {
            const resultsHeader = document.getElementById('results-header')
            const resultsBody = document.getElementById('results-body')
            
            console.log('Rendering results table with codes:', currentCodes.length, 'files:', uploadedFiles.length)
            
            if (currentCodes.length === 0 || uploadedFiles.length === 0) {
                resultsHeader.innerHTML = `
                    <tr>
                        <th>Article</th>
                        <th class="code-header placeholder-code">Add Codes</th>
                        <th class="code-header placeholder-code">Define Schemes</th>
                        <th class="code-header placeholder-code">Upload Files</th>
                    </tr>
                `
                
                resultsBody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 2rem; color: #6c757d;">
                            ${currentCodes.length === 0 ? 'Add coding schemes in the "Coding Schemes" tab' : ''}
                            ${uploadedFiles.length === 0 ? 'Upload PDF files in the "Upload Articles" tab' : ''}
                        </td>
                    </tr>
                `
                return
            }
            
            let headerHTML = '<tr><th>Article</th>'
            currentCodes.forEach(code => {
                headerHTML += `<th class="code-header real-code">${escapeHtml(code.name)}</th>`
            })
            headerHTML += '</tr>'
            resultsHeader.innerHTML = headerHTML
            
            let bodyHTML = ''
            uploadedFiles.forEach(file => {
                bodyHTML += `<tr><td>${escapeHtml(file.name)}</td>`
                currentCodes.forEach(code => {
                    bodyHTML += `<td class="code-cell">-</td>`
                })
                bodyHTML += '</tr>'
            })
            
            if (uploadedFiles.length > 0 && currentCodes.length > 0) {
                bodyHTML += '<tr class="totals-row"><td><strong>TOTAL</strong></td>'
                currentCodes.forEach(() => {
                    bodyHTML += '<td class="code-cell"><strong>0</strong></td>'
                })
                bodyHTML += '</tr>'
            }
            
            resultsBody.innerHTML = bodyHTML
        }

        function updateSaveStatus(saved) {
            const saveStatus = document.getElementById('save-status')
            if (saved) {
                saveStatus.textContent = 'All changes saved'
                saveStatus.style.color = '#28a745'
            } else {
                saveStatus.textContent = 'Unsaved changes'
                saveStatus.style.color = '#dc3545'
            }
        }

        async function startAnalysis() {
            if (!currentUser) {
                showAlert('Please sign in to run analysis', 'error')
                return
            }

            if (currentCodes.length === 0) {
                showAlert('Please add at least one code in the Coding Schemes tab', 'error')
                return
            }

            if (uploadedFiles.length === 0) {
                showAlert('Please upload at least one PDF file', 'error')
                return
            }

            const analysisBtn = document.getElementById('start-analysis-btn')
            const progressDiv = document.getElementById('analysis-progress')
            const progressFill = document.getElementById('progress-fill')
            const progressText = document.getElementById('progress-text')

            analysisBtn.disabled = true
            analysisBtn.textContent = 'Running Analysis...'
            progressDiv.classList.remove('hidden')
            
            try {
                const totalSteps = uploadedFiles.length * currentCodes.length
                let completedSteps = 0

                progressText.textContent = 'Initializing analysis...'
                progressFill.style.width = '0%'

                analysisResults = []

                for (let fileIndex = 0; fileIndex < uploadedFiles.length; fileIndex++) {
                    const file = uploadedFiles[fileIndex]
                    const fileResults = {
                        filename: file.name,
                        codes: {}
                    }

                    for (let codeIndex = 0; codeIndex < currentCodes.length; codeIndex++) {
                        const code = currentCodes[codeIndex]
                        
                        progressText.textContent = `Analyzing "${file.name}" for "${code.name}"...`
                        
                        try {
                            const result = await analyzeFileForCode(file, code)
                            fileResults.codes[code.name] = result
                        } catch (error) {
                            console.error(`Error analyzing ${file.name} for ${code.name}:`, error)
                            fileResults.codes[code.name] = {
                                value: 0,
                                evidence: [],
                                error: error.message
                            }
                        }

                        completedSteps++
                        const progress = (completedSteps / totalSteps) * 100
                        progressFill.style.width = `${progress}%`
                        
                        await new Promise(resolve => setTimeout(resolve, 100))
                    }

                    analysisResults.push(fileResults)
                }

                progressText.textContent = 'Analysis complete!'
                progressFill.style.width = '100%'

                updateResultsTable()
                enableExportButtons()
                showAlert('Analysis completed successfully!', 'success')

            } catch (error) {
                console.error('Analysis error:', error)
                showAlert(`Analysis failed: ${error.message}`, 'error')
            } finally {
                analysisBtn.disabled = false
                analysisBtn.textContent = 'Start AI Analysis'
                
                setTimeout(() => {
                    progressDiv.classList.add('hidden')
                }, 2000)
            }
        }

        async function analyzeFileForCode(file, code) {
            await new Promise(resolve => setTimeout(resolve, 500))
            
            const randomValue = Math.random() > 0.5 ? 1 : 0
            const evidence = randomValue === 1 ? [
                {
                    quote: `Sample evidence for ${code.name} found in the text`,
                    page: Math.floor(Math.random() * 5) + 1,
                    confidence: 0.8 + Math.random() * 0.2
                }
            ] : []

            return {
                value: randomValue,
                evidence: evidence,
                model: 'gpt-3.5-turbo',
                timestamp: new Date().toISOString()
            }
        }

        function updateResultsTable() {
            const resultsBody = document.getElementById('results-body')
            
            let bodyHTML = ''
            const totals = {}
            
            currentCodes.forEach(code => {
                totals[code.name] = 0
            })

            analysisResults.forEach(result => {
                bodyHTML += `<tr><td>${escapeHtml(result.filename)}</td>`
                
                currentCodes.forEach(code => {
                    const codeResult = result.codes[code.name]
                    if (codeResult) {
                        bodyHTML += `<td class="code-cell">${codeResult.value}</td>`
                        totals[code.name] += codeResult.value
                    } else {
                        bodyHTML += `<td class="code-cell">-</td>`
                    }
                })
                
                bodyHTML += '</tr>'
            })

            bodyHTML += '<tr class="totals-row"><td><strong>TOTAL</strong></td>'
            currentCodes.forEach(code => {
                bodyHTML += `<td class="code-cell"><strong>${totals[code.name]}</strong></td>`
            })
            bodyHTML += '</tr>'
            
            resultsBody.innerHTML = bodyHTML
        }

        function enableExportButtons() {
            document.getElementById('export-btn').disabled = false
            document.getElementById('summaries-btn').disabled = false
            document.getElementById('export-status').textContent = 'Analysis complete - ready to export'
        }

        function exportResults() {
            if (analysisResults.length === 0) {
                showAlert('No analysis results to export', 'warning')
                return
            }

            let csv = 'Filename'
            currentCodes.forEach(code => {
                csv += `,${code.name}`
            })
            csv += '\n'

            analysisResults.forEach(result => {
                csv += `"${result.filename}"`
                currentCodes.forEach(code => {
                    const codeResult = result.codes[code.name]
                    csv += `,${codeResult ? codeResult.value : 0}`
                })
                csv += '\n'
            })

            csv += 'TOTAL'
            const totals = {}
            currentCodes.forEach(code => {
                totals[code.name] = 0
            })

            analysisResults.forEach(result => {
                currentCodes.forEach(code => {
                    const codeResult = result.codes[code.name]
                    if (codeResult) {
                        totals[code.name] += codeResult.value
                    }
                })
            })

            currentCodes.forEach(code => {
                csv += `,${totals[code.name]}`
            })

            const blob = new Blob([csv], { type: 'text/csv' })
            const url = window.URL.createObjectURL(blob)
            const a = document.createElement('a')
            a.href = url
            a.download = `analysis_results_${new Date().toISOString().split('T')[0]}.csv`
            document.body.appendChild(a)
            a.click()
            document.body.removeChild(a)
            window.URL.revokeObjectURL(url)

            showAlert('Results exported successfully!', 'success')
        }

        function generateAllSummaries() {
            if (analysisResults.length === 0) {
                showAlert('No analysis results to summarize', 'warning')
                return
            }

            const summarySection = document.getElementById('summary-section')
            const summaryContent = document.getElementById('summary-content')
            
            let summariesHTML = ''
            
            currentCodes.forEach(code => {
                const total = analysisResults.reduce((sum, result) => {
                    const codeResult = result.codes[code.name]
                    return sum + (codeResult ? codeResult.value : 0)
                }, 0)
                
                const percentage = (total / analysisResults.length * 100).toFixed(1)
                
                summariesHTML += `
                    <div class="code-item">
                        <h4>${escapeHtml(code.name)}</h4>
                        <p><strong>Frequency:</strong> ${total}/${analysisResults.length} articles (${percentage}%)</p>
                        <p><strong>Summary:</strong> This code appeared in ${percentage}% of analyzed articles, indicating ${percentage > 50 ? 'high' : 'low'} prevalence of this theme in the dataset.</p>
                    </div>
                `
            })
            
            summaryContent.innerHTML = summariesHTML
            summarySection.classList.remove('hidden')
            
            showAlert('AI summaries generated!', 'success')
        }
    </script>
</body>
</html>
